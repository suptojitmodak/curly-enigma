<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkShort | Free URL Shortener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f7fafc;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a365d;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .toast.show {
            opacity: 1;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Header -->
    <header class="bg-white shadow-sm py-3 px-4 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="material-icons text-blue-600">insert_link</span>
                <h1 class="text-xl font-bold text-blue-600">LinkShort</h1>
            </div>
            <button id="newLinkBtn" class="flex items-center space-x-1 bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm hover:bg-blue-700 transition">
                <span class="material-icons text-sm">add</span>
                <span>New Link</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto py-6 px-4">
        <!-- URL Shortener Section -->
        <section id="shortenerSection" class="bg-white rounded-lg shadow-sm p-5 mb-6">
            <h2 class="text-lg font-semibold mb-4 text-gray-800">Create Short Link</h2>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Destination URL</label>
                    <input type="url" id="originalUrl" placeholder="https://example.com" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <p id="urlError" class="mt-1 text-sm text-red-600 hidden"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Custom Alias (optional)</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 bg-gray-100 border border-r-0 rounded-l-md text-gray-600 text-sm">${window.location.hostname}/?u=</span>
                        <input type="text" id="customSlug" placeholder="myalias" 
                            class="flex-1 px-3 py-2 border rounded-r-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <p id="slugError" class="mt-1 text-sm text-red-600 hidden"></p>
                </div>
                <button id="shortenBtn" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition flex justify-center items-center space-x-2">
                    <span id="shortenText">Shorten URL</span>
                    <span id="shortenSpinner" class="loading-spinner hidden"></span>
                </button>
            </div>
        </section>

        <!-- Result Section -->
        <div id="resultSection" class="hidden bg-white rounded-lg shadow-sm p-5 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-800">Your Short Link</h3>
                <div class="flex items-center space-x-1 text-sm text-gray-500">
                    <span class="material-icons text-sm">visibility</span>
                    <span id="viewCount">0</span>
                    <span>views</span>
                </div>
            </div>
            <div class="flex items-center space-x-2 mb-3">
                <input type="text" id="shortUrl" readonly 
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                <button id="copyBtn" class="p-2 rounded-md hover:bg-gray-100 transition">
                    <span class="material-icons text-gray-700">content_copy</span>
                </button>
            </div>
            <div class="flex space-x-2">
                <button id="qrBtn" class="flex-1 flex items-center justify-center space-x-1 bg-gray-100 hover:bg-gray-200 py-2 rounded-md transition text-sm">
                    <span class="material-icons text-sm">qr_code</span>
                    <span>QR Code</span>
                </button>
            </div>
            <div class="mt-3 text-xs text-gray-500">
                Created: <span id="createdAt">just now</span>
            </div>
        </div>

        <!-- Links Section -->
        <section id="contentSection">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold text-gray-800">Your Links</h2>
                <button id="refreshBtn" class="text-blue-600 hover:text-blue-800 flex items-center space-x-1 text-sm">
                    <span class="material-icons text-sm">refresh</span>
                    <span>Refresh</span>
                </button>
            </div>
            <div id="contentList" class="space-y-3">
                <!-- Links will be loaded here -->
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <p class="text-gray-500 text-center">No links created yet</p>
                </div>
            </div>
        </section>
    </main>

    <!-- QR Code Modal -->
    <div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-5 max-w-xs w-full shadow-lg">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold">QR Code</h3>
                <button id="closeQrModal" class="text-gray-500 hover:text-gray-700">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div id="qrCode" class="flex justify-center mb-3"></div>
            <p class="text-center text-sm text-gray-600 mb-3">Scan to visit the link</p>
            <button id="downloadQrBtn" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition">
                Download QR Code
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const toast = document.getElementById('toast');
        const originalUrlInput = document.getElementById('originalUrl');
        const customSlugInput = document.getElementById('customSlug');
        const shortenBtn = document.getElementById('shortenBtn');
        const shortenText = document.getElementById('shortenText');
        const shortenSpinner = document.getElementById('shortenSpinner');
        const resultSection = document.getElementById('resultSection');
        const shortUrlElement = document.getElementById('shortUrl');
        const viewCountElement = document.getElementById('viewCount');
        const createdAtElement = document.getElementById('createdAt');
        const copyBtn = document.getElementById('copyBtn');
        const qrBtn = document.getElementById('qrBtn');
        const qrModal = document.getElementById('qrModal');
        const closeQrModal = document.getElementById('closeQrModal');
        const qrCodeElement = document.getElementById('qrCode');
        const downloadQrBtn = document.getElementById('downloadQrBtn');
        const newLinkBtn = document.getElementById('newLinkBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const contentList = document.getElementById('contentList');
        const urlError = document.getElementById('urlError');
        const slugError = document.getElementById('slugError');

        // LocalStorage-based database simulation
        const db = {
            getLinks: () => {
                const links = localStorage.getItem('linkshort_links');
                return links ? JSON.parse(links) : {};
            },
            saveLink: (slug, data) => {
                const links = db.getLinks();
                links[slug] = data;
                localStorage.setItem('linkshort_links', JSON.stringify(links));
                return true;
            },
            getLink: (slug) => {
                const links = db.getLinks();
                return links[slug] || null;
            },
            incrementView: (slug) => {
                const links = db.getLinks();
                if (links[slug]) {
                    links[slug].viewCount = (links[slug].viewCount || 0) + 1;
                    localStorage.setItem('linkshort_links', JSON.stringify(links));
                }
            }
        };

        // Show toast message
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Generate random slug
        function generateSlug() {
            return Math.random().toString(36).substring(2, 8);
        }

        // Format date
        function formatDate(date) {
            const now = new Date();
            const diff = now - new Date(date);
            const seconds = Math.floor(diff / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            return new Date(date).toLocaleDateString();
        }

        // Validate URL
        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        // Validate slug
        function isValidSlug(slug) {
            return /^[a-z0-9_-]+$/i.test(slug);
        }

        // Create short link
        async function createShortLink() {
            const originalUrl = originalUrlInput.value.trim();
            let customSlug = customSlugInput.value.trim();
            
            // Validate URL
            if (!originalUrl) {
                urlError.textContent = 'Please enter a URL';
                urlError.classList.remove('hidden');
                originalUrlInput.focus();
                return;
            }
            
            if (!isValidUrl(originalUrl)) {
                urlError.textContent = 'Please enter a valid URL (include http:// or https://)';
                urlError.classList.remove('hidden');
                originalUrlInput.focus();
                return;
            }
            
            urlError.classList.add('hidden');
            
            // Validate custom slug if provided
            if (customSlug) {
                if (!isValidSlug(customSlug)) {
                    slugError.textContent = 'Only letters, numbers, hyphens and underscores allowed';
                    slugError.classList.remove('hidden');
                    customSlugInput.focus();
                    return;
                }
                
                // Check if slug exists
                if (db.getLink(customSlug)) {
                    slugError.textContent = 'This alias is already taken';
                    slugError.classList.remove('hidden');
                    customSlugInput.focus();
                    return;
                }
                
                slugError.classList.add('hidden');
            } else {
                customSlug = generateSlug();
            }
            
            // Show loading
            shortenText.classList.add('hidden');
            shortenSpinner.classList.remove('hidden');
            shortenBtn.disabled = true;
            
            // Create link data
            const createdAt = new Date().toISOString();
            const shortUrl = `${window.location.origin}${window.location.pathname}?u=${customSlug}`;
            
            // Save to database
            const success = db.saveLink(customSlug, {
                originalUrl: originalUrl,
                createdAt: createdAt,
                viewCount: 0
            });
            
            if (success) {
                // Show result
                shortUrlElement.value = shortUrl;
                viewCountElement.textContent = '0';
                createdAtElement.textContent = formatDate(createdAt);
                resultSection.classList.remove('hidden');
                
                // Generate QR code
                QRCode.toCanvas(qrCodeElement, shortUrl, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#2563eb',
                        light: '#ffffff'
                    }
                });
                
                showToast('Link created successfully!');
                loadLinks();
                
                // Scroll to result
                setTimeout(() => {
                    resultSection.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            } else {
                showToast('Failed to create link. Please try again.');
            }
            
            // Reset loading
            shortenText.classList.remove('hidden');
            shortenSpinner.classList.add('hidden');
            shortenBtn.disabled = false;
        }

        // Load user's links
        function loadLinks() {
            const links = db.getLinks();
            const linksArray = Object.keys(links).map(slug => ({
                slug,
                ...links[slug]
            }));
            
            // Sort by date (newest first)
            linksArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (linksArray.length === 0) {
                contentList.innerHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <p class="text-gray-500 text-center">No links created yet</p>
                    </div>
                `;
                return;
            }
            
            contentList.innerHTML = '';
            
            linksArray.forEach(link => {
                const linkElement = document.createElement('div');
                linkElement.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition';
                linkElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${link.originalUrl}</p>
                            <p class="text-xs text-blue-600 mt-1 truncate">${window.location.hostname}${window.location.pathname}?u=${link.slug}</p>
                            <div class="flex items-center mt-2 text-xs text-gray-500">
                                <span>${link.viewCount || 0} views</span>
                                <span class="mx-1">•</span>
                                <span>${formatDate(link.createdAt)}</span>
                            </div>
                        </div>
                        <div class="flex space-x-1 ml-2">
                            <button class="copy-link p-1 text-gray-500 hover:text-blue-600" data-url="${window.location.hostname}${window.location.pathname}?u=${link.slug}">
                                <span class="material-icons text-sm">content_copy</span>
                            </button>
                            <a href="?u=${link.slug}" target="_blank" class="p-1 text-gray-500 hover:text-blue-600">
                                <span class="material-icons text-sm">open_in_new</span>
                            </a>
                        </div>
                    </div>
                `;
                contentList.appendChild(linkElement);
            });
            
            // Add copy event listeners
            document.querySelectorAll('.copy-link').forEach(btn => {
                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(btn.getAttribute('data-url'));
                    showToast('Link copied to clipboard!');
                });
            });
        }

        // Check for redirect
        function checkForRedirect() {
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('u');
            
            if (slug) {
                const link = db.getLink(slug);
                if (link && link.originalUrl) {
                    // Increment view count
                    db.incrementView(slug);
                    
                    // Redirect
                    window.location.href = link.originalUrl;
                } else {
                    // Invalid link, show main page
                    showToast('Invalid or expired link');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        // Download QR code
        function downloadQRCode() {
            const canvas = qrCodeElement.querySelector('canvas');
            if (!canvas) return;
            
            const link = document.createElement('a');
            link.download = `linkshort-${new Date().getTime()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        // Event Listeners
        shortenBtn.addEventListener('click', createShortLink);
        
        newLinkBtn.addEventListener('click', () => {
            originalUrlInput.value = '';
            customSlugInput.value = '';
            resultSection.classList.add('hidden');
            urlError.classList.add('hidden');
            slugError.classList.add('hidden');
            originalUrlInput.focus();
        });
        
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(shortUrlElement.value);
            showToast('Link copied to clipboard!');
        });
        
        qrBtn.addEventListener('click', () => {
            qrModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });
        
        closeQrModal.addEventListener('click', () => {
            qrModal.classList.add('hidden');
            document.body.style.overflow = '';
        });
        
        downloadQrBtn.addEventListener('click', downloadQRCode);
        
        refreshBtn.addEventListener('click', () => {
            loadLinks();
            showToast('Links refreshed');
        });
        
        // Handle Enter key
        originalUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createShortLink();
        });
        
        customSlugInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') createShortLink();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkForRedirect();
            loadLinks();
        });
    </script>
</body>
</html>
